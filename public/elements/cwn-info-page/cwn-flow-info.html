<dom-module id="cwn-flow-info">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <h4>Aggregate Flow</h4>

    <cwn-date-linechart id="inflowChart"></cwn-date-linechart>

    <div class="modal fade" id="popup">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-label="Close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="title">Details</h4>
          </div>
          <div class="modal-body">
            <div id="colChartRoot" style="height: 500px"></div>
          </div>
        </div>
      </div>
    </div>


  </template>
  <script>
    Polymer({
      is: 'cwn-flow-info',

      ready : function() {
        this.popup = $(this.$.popup).remove();
        $('body').append(this.popup);
        this.popup.modal({show: false});
      },

      update : function(feature) {
        if( this.feature && feature.properties.prmname == this.feature.properties.prmname ) {
          return;
        }

        this.feature = feature;

        //this.$.flow.style.display = 'none';
        this.net = false;
        var props = this.feature.properties;

        if( props.type == 'Region Link' ) {
          //$(this).parent().show();
          //this.$.loading.style.display = 'block';
          //this.loadLinkAggregate();
       } else if( props.type == 'Region' ) {
          //$(this).parent().show();
          //this.$.loading.style.display = 'block';
          this.loadAggregate();


       } else if( props.extras &&
          (props.extras.inflow || props.extras.flow || props.extras.sinks || props.extras.evaporation) ) {
        //    $(this).parent().show();
        //    this.$.loading.style.display = 'block';
        //    this.load();
        } else {
          $(this).parent().hide();
          this.$.loading.style.display = 'none';
        }
      },

      loadAggregate : function() {
        $.get('/regions/aggregateRegion?region='+this.feature.properties.prmname, function(resp) {
          this.data = resp;

          var inflowdata = [['Date','Amplitude Loss', 'Local Sinks', 'Evaporation', 'Link Outflows', '', 'Local Inflows', 'Link Inflows']];

          for( var date in resp.aggregate ) {

            var localInflow = this.data.aggregate[date].inflows || 0;
            var linkInflow = this.data.aggregate[date].regionLinkInflow || 0;

            var sink = 0;
            var evaporation = this.data.aggregate[date].evaporation ? this.data.aggregate[date].evaporation*-1 : 0;
            var linkOutflow = this.data.aggregate[date].regionLinkOutflow ? this.data.aggregate[date].regionLinkOutflow*-1 : 0;
            var ampLoss = this.data.aggregate[date].amplitudeLoss ? this.data.aggregate[date].amplitudeLoss*-1 : 0;

            inflowdata.push([
              date,
              ampLoss,
              sink,
              evaporation,
              linkOutflow,
              (sink + evaporation + linkOutflow + ampLoss)*-1,
              localInflow,
              linkInflow
            ]);
          }

          this.$.inflowChart.options = {
            isStacked : true,
            title : 'Flow',
            legend : {
              position: 'right'
            },
            series: {
              4: {
                  visibleInLegend: false,
                  areaOpacity : 0,
                  color : 'transparent'
              }
            }
          }
          this.$.inflowChart.onClick = this.onChartClick.bind(this);
          this.$.inflowChart.type = 'AreaChart';
          this.$.inflowChart.update(inflowdata);

          /*this.$.outflowChart.options = {
            isStacked : true,
            title : 'Outflows',
            vAxis : {
              maxValue : 0
            },
            legend : {
              position: 'right'
            }
          }
          this.$.outflowChart.onClick = this.onChartClick.bind(this);
          this.$.outflowChart.type = 'AreaChart';
          this.$.outflowChart.update(outflowdata);*/

        }.bind(this));
      },

      onChartClick : function(e) {
        var row = e[0].row;
        var date = Object.keys(this.data.aggregate)[row];

        this.popup.modal('show');
        this.$.colChartRoot.innerHTML = '';

        var localInflow = this.data.aggregate[date].inflows || 0;
        var linkInflow = this.data.aggregate[date].regionLinkInflow || 0;
        var evaporation = this.data.aggregate[date].evaporation ? this.data.aggregate[date].evaporation*-1 : 0;
        var linkOutflow = this.data.aggregate[date].regionLinkOutflow ? this.data.aggregate[date].regionLinkOutflow*-1 : 0;
        var ampLoss = this.data.aggregate[date].amplitudeLoss ? this.data.aggregate[date].amplitudeLoss*-1 : 0;

        var data = [
          ['Local Inflows', localInflow,'#4caf50'],
          ['Link Inflows', linkInflow,'#4caf50'],
          ['Local Sinks', 0, '#e51c23'],
          ['Evaporation', evaporation, '#e51c23'],
          ['Link Outflows', linkOutflow, '#e51c23'],
          ['Amplitude Loss', ampLoss, '#e51c23']
        ];

        data.sort(function(a, b){
          if( a[1] < b[1] ) return -1;
          if( b[1] < a[1] ) return 1;
          return 0;
        });
        data.splice(0,0,['Type', 'Value',{ role: "style" }]);
        data.push(['Difference', localInflow + linkInflow+evaporation + linkOutflow + ampLoss, '#ff9800']);

        var dt = google.visualization.arrayToDataTable(data);
        var options = {
          title: date,
          height: 500,
          legend: { position: 'none' },
        };

        setTimeout(function(){
            var chart = new google.visualization.ColumnChart(this.$.colChartRoot);
            chart.draw(dt, options);
        }.bind(this), 500);
      }

    });
  </script>
</dom-module>
