<link rel="import" href="node/cwn-node-info.html" />
<link rel="import" href="cost/cwn-cost-info.html" />
<link rel="import" href="cwn-output-info.html" />

<dom-module id="cwn-info-page">
    <style>
      :host {
        display: block;
        overflow-x: hidden;
        margin-bottom: 100px;
      }
      .card {
        margin: 10px 10px 10px 10px;
        box-shadow: 0 0 5px #888;
        padding: 15px;
      }
    </style>

    <template>

      <div class="card" hidden$="{{loading}}" style="margin-top: 25px">
        <cwn-node-info
          id="nodeInfo"
          feature="{{feature}}"
          ds="{{ds}}"
          leaflet="{{map}}">
        </cwn-node-info>
      </div>

      <!-- End Header Card -->
      <div class="row" hidden$="{{loading}}">
        <div class="col-md-6">

          <!-- Start Climate -->
          <div class="card" hidden$="{{!showClimateData}}">
            <h2 class="page-header">Climate</h2>

            <div class="alert alert-error" hidden$="{{!climateLoadError}}">
              Error loading climate data.
            </div>
            <div hidden$="{{!climateLoading}}" style="color:#888">
              Loading climate data...
            </div>

            <div hidden$="{{!showClimateData}}">

              <div hidden$="{{!inflows.length}}">
                <h4>Inflows</h4>
              </div>

              <div id="inflows">
                <h4>Inflows</h4>
                <div id="inflowCharts"></div>
              </div>

              <div id="eacChartRoot"></div>
              <template id="eacChart" is="dom-template">
                <h4>Elevation / Area / Capacity</h4>
                <cwn-linechart
                  data="{{data}}"
                  cols="{{cols}}"
                  options="{{options}}"
                  type="{{type}}">
                </cwn-linechart>
              </template>

              <div id="evaporation" style="display:none">
                <h4>Evaporation</h4>
                <cwn-date-linechart animate id="evaporationChart"></cwn-date-linechart>
              </div>

            </div>
          </div>
          <!-- End Climate -->

        </div>
        <div class="col-md-6">

          <!-- Start Costs -->
          <div class="card">
            <cwn-cost-info
              feature="{{feature}}">
            </cwn-cost-info>
          </div>
          <!-- End Costs -->

        </div>
      </div>

      <div class="card">
        <cwn-output-info id="outputs" on-region-link-update="onRegionLinkUpdate"></cwn-output-info>
      </div>

      <div class="card" id="readme" style="display:none">
        <h4 class="page-header">README</h4>
        <div id="readmeMarkdown"></div>
      </div>

      <cwn-dateslider
        id="dateslider"
        start="1920-01-01"
        on-values-changed="updateDateFilters">
      </cwn-dateslider>


    </template>
</dom-module>
<script>
Polymer({
    is : 'cwn-info-page',

    ready : function() {
      this.feature = null;

      this.hack = '';
      this.islocal = false;

      this.tableProperties = ['prmname'];

      // loading flags
      this.climateLoadError = false;
      this.costLoadError = false;
      this.climateLoading = false;
      this.costLoading = false;
      this.loading = false;

        // have to do long lookup right now, is there are better way?
      this.origins = [];
      this.terminals = [];

      // render data.  Data in a format ready to draw above
      this.inflows = [],

      this.map = {};

      // Elevation / Area / Capacity charts
      this.eacChart = {
        type : 'ComboChart',
        cols : [
          {id: 'capacity', label: 'capacity', type: 'number'},
          {id: 'elevation', label: 'elevation', type: 'number'},
          {id: 'area', label: 'area', type: 'number'},
          {id: 'initial', type: 'number', label: 'initial'},
          {id: 'tooltip', type: 'string', role:'tooltip'}
        ],
        data : [],
        options : {
          hAxis : {
            title : 'Capacity (kAF)'
          },
          vAxes : [
            {title:'Elevation (ft)'}, // axis 0
            {title:'Area (ac)'} // Axis 1
          ],
          seriesType: "bars",
          series :{
            0: {type: "line", targetAxisIndex:0},
            1: {type: "line", targetAxisIndex:1},
            2: {targetAxisIndex: 0},
          },
          interpolateNulls : true,
          legend : {
            position: 'top'
          }
        }
      };

      // date filtering
      this.filters = {
        start : null,
        stop : null
      },

      // dom controller stuff
      this.hasTimeSeries = false;
      this.showClimateData = false;
      this.charts = {};

    },

    init : function(map) {
      this.map = map;
      this.islocal = CWN.ds.islocal;

      CWN.ds.on('load', this.onLoad.bind(this));
    },

    onLoad : function() {
      if( CWN.ds.loading ) return;

      var loc = window.location.hash.replace('#','').split('/');
      if( loc[0] == 'info' && loc.length > 1) {
        if( this.feature && this.feature.prmname == loc[1] ) {
          this.update();
        } else {
          this.setFeature(loc[1]);
        }
      }
    },

    setFeature : function(prmname) {
      if( CWN.ds.lookupMap[prmname] ) {
        this.feature = CWN.ds.lookupMap[prmname];
      } else {
        // see if this is a region to feature
        this.setRegionToRegion(prmname);
      }

      this.update();
    },

    setRegionToRegion : function(prmname) {
      var parts = prmname.split('--');

      if( parts.length == 0 ) {
        this.feature = null;
        return;
      }

      var node = {
        properties : {
          prmname : prmname,
          origin : null,
          terminus : null,
          type : 'Region Link'
        }
      };

      if( CWN.ds.lookupMap[parts[0]] ) {
        node.properties.origin = CWN.ds.lookupMap[parts[0]].properties.prmname;
      } else if( CWN.ds.regionLookupMap[parts[0]] ) {
        node.properties.origin = CWN.ds.regionLookupMap[parts[0]].name;
      }

      if( CWN.ds.lookupMap[parts[1]] ) {
        node.properties.terminus = CWN.ds.lookupMap[parts[1]].properties.prmname;
      } else if( CWN.ds.regionLookupMap[parts[1]] ) {
        node.properties.terminus = CWN.ds.regionLookupMap[parts[1]].name;
      }

      if( !node.properties.origin || !node.properties.terminus ) {
        this.feature = null;
        return;
      }

      this.feature = node;
    },

    update : function() {
      if( CWN.ds.loading ) return;

      if( this.feature == null ) return alert('Feature not found');

      this.climateLoadError = false;
      this.climateLoading = false;

      this.hasOutputs = false;
      this.eacChart.data = [];
      this.evaporationData = null;
      this.hasInflows = false;
      this.hasEvaporation = false;

      var props = this.feature.properties;
      if( (props.extras && props.extras.inflows) || props.el_ar_cap || (props.extras && props.extras.evaporation)) {
        this.showClimateData = true;
      } else {
        this.showClimateData = false;
      }

      this.renderClimateData(props.el_ar_cap);


      this.$.outputs.update(this.feature);
      if( this.feature.properties.hasOutputs ) {
        this.hasOutputs = true;
      }

      this.updateReadme();

      this.updateDateSliderVisibility();
      this.async(function(){
        this.$.dateslider.resize();
      });

    },

    updateReadme : function() {
        if( this.feature.properties.extras && this.feature.properties.extras.readme ) {
          this.$.readme.style.display = 'block';
          CWN.ds.loadExtras(this.feature.properties.prmname, function(resp){
            this.$.readmeMarkdown.innerHTML = marked(resp.readme);
          }.bind(this));
          return;
        }

        this.$.readme.style.display = 'none';
        return;
    },

    renderClimateData : function(el_ar_cap) {
      this.renderInflows();
      this.renderEvaporation();

      this.eacChart.data = [];
      if( el_ar_cap ) {

        var max = 0;
        var elevationCol = 0, capacityCol = 0, areaCol = 0;

        for( var i = 0; i < el_ar_cap.length; i++ ) {
          // make sure col labels are set correctly
          if( i == 0 ) {
            for( var j = 0; j < el_ar_cap[i].length; j ++ ) {
              if( el_ar_cap[i][j].toLowerCase() == 'elevation' ) elevationCol = j;
              else if( el_ar_cap[i][j].toLowerCase() == 'capacity' ) capacityCol = j;
              else if( el_ar_cap[i][j].toLowerCase() == 'area' ) areaCol = j;
            }
          } else {
            this.eacChart.data.push([
              el_ar_cap[i][capacityCol],
              el_ar_cap[i][elevationCol],
              el_ar_cap[i][areaCol],
              null,
              null
            ]);
          }

          if( el_ar_cap[i][elevationCol] > max ) max = el_ar_cap[i][elevationCol];
        }

        if( this.feature.properties.initialstorage ) {
          this.eacChart.data.push([
            this.feature.properties.initialstorage,
            null,
            null,
            max,
            'Initial: '+this.feature.properties.initialstorage
          ]);
        }

        this.eacChart.data.sort(function(a,b){
          if( a[capacityCol] > b[capacityCol] ) return 1;
          if( a[capacityCol] < b[capacityCol] ) return -1;
          return 0;
        });

        this.stampEacChart();
      }


      this.updateDateSliderVisibility();
    },

    renderInflows : function() {
      this.$.inflows.style.display = 'none';

      CWN.ds.loadExtras(this.feature.properties.prmname, function(resp){
        if( resp.inflows ) {
          this.hasInflows = true;
          this.$.inflowCharts.innerHTML = '';

          for( var name in resp.inflows  ) {
            var chart = document.createElement('cwn-date-linechart');
            chart.label = (resp.inflows[name].description || name || ''),
            chart.data = resp.inflows[name].inflow;

            this.$.inflowCharts.appendChild(chart);
          }

          this.$.inflows.style.display = 'block';
        } else {
          this.$.inflows.style.display = 'none';
        }
      }.bind(this));
    },

    renderEvaporation : function() {
      CWN.ds.loadExtras(this.feature.properties.prmname, function(resp){
        var evaporation = resp.evaporation;
        if( evaporation ) {
          this.hasEvaporation = true;
          this.$.evaporationChart.update(evaporation);
          this.evaporationData = evaporation;
          this.$.evaporation.style.display = 'block';
        } else {
          this.$.evaporation.style.display = 'none';
        }
      }.bind(this));
    },

    updateDateFilters : function(e) {
      var eles = this.querySelectorAll('cwn-date-linechart');

      for( var i = 0; i < eles.length; i++ ) {
        eles[i].startDate = e.detail.start;
        eles[i].stopDate = e.detail.end;

        eles[i].update();
      }

      this.notifyPath('filters.start', e.detail.start);
      this.notifyPath('filters.stop', e.detail.end);
    },

    _setCostMonth : function(e) {
      this.$.costInfo.setMonth(parseInt(e.currentTarget.getAttribute('index')));
    },

    // dom-template: http://polymer.github.io/polymer/
    // doesn't seem to take variables when you stamp now :(
    // setting manually.
    _stamp : function(ele, query, data) {
      var template = ele.stamp();

      if( query && data ) {
        var newEle = template.root.querySelector(query);
        if( newEle ) {
          for( var key in data ) newEle[key] = data[key];
        }
      }

      return template;
    },

    updateDateSliderVisibility : function() {
      this.$.dateslider.setFeature(this.feature);
    },

    stampEacChart : function() {
      if( !this.eacChart ) return;

        if( this.eacChart.data.length == 0 ) {

            this.charts.eacChart = null;
            this.$.eacChartRoot.innerHTML = '';

        } else if( !this.charts.eacChart ) {

            this.charts.eacChart = this._stamp(this.$.eacChart, 'cwn-linechart', this.eacChart);
            this.$.eacChartRoot.appendChild(this.charts.eacChart.root);

            this.async(function(){
                this.$.eacChartRoot.querySelector('cwn-linechart').update(this.eacChart.data);
            });
        }
    },

    onRegionLinkUpdate : function(e) {
      this.$.nodeInfo.setRegionLinkInfo(e.detail);
    }
});
</script>
