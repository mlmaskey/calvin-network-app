
<!--
    data should be format [[date,value],[date,value]...]
-->
<polymer-element name="cwn-date-linechart" attributes="label xlabel ylabel data start stop height options cols type">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <div id="root" style="height:{{height}}px"></div>
    </template>
    <script>
        Polymer('cwn-date-linechart',{
            dt : null,
            chart : null,
            height : 400,

            updateTimer : -1,

            observe : {
                label : 'redraw',
                xlabel : 'redraw',
                ylabel : 'redraw',
                height : 'redraw',
                data  : 'update',
                start : 'update',
                stop  : 'update'
            },

            options : null,
            type : null,
            cols : null,

            onLoadHandlerSet : false,

            ready : function() {
                $(window).on('resize', function(){
                    this.redraw();
                }.bind(this));
            },

            setOnloadHandler : function() {
                if( this.onLoadHandlerSet ) return;

                // put in global scope by cwn-datastore
                chartLoadHandlers.push(function(){
                    this.update();
                }.bind(this));
            },
            

            update : function() {
                if( !window.google.visualization ) return this.setOnloadHandler();
                if( !window.google.visualization.LineChart ) return this.setOnloadHandler();

                if( !this.chart ) {
                    if( this.type ) {
                        this.chart = new google.visualization[this.type](this.$.root);
                    } else {
                        this.chart = new google.visualization.LineChart(this.$.root);
                    }
                }

                if( !this.cols ) {
                    if( !this.data ) this.data = ['date', 'value'];
                    if( typeof this.data[0][1] != 'string' ) this.data.splice(0, 0, ['date', 'value']);
                }
                

                if( this.updateTimer == -1 ) clearTimeout(this.updateTimer);
                this.updateTimer = setTimeout(function() {
                    this.updateTimer = -1;
                    this._update();
                }.bind(this), 500);
            },

            _setDataTable : function(data) {
                if( this.cols ) {
                    this.dt = new google.visualization.DataTable();
                    for( var i = 0; i < this.cols.length; i++ ) {
                        this.dt.addColumn(this.cols[i]);
                    }
                    this.dt.addRows(data);
                } else {
                    this.dt = google.visualization.arrayToDataTable(data);
                }
            },

            _update : function() {
                if( !this.start && !this.stop ) {
                    this._setDataTable(this.data);
                    this.redraw();
                    return;
                }

                var filteredData = [this.data[0]];
                var d;
                for( var i = 1; i < this.data.length; i++ ) {
                    d = new Date(this.data[i][0]).getTime();

                    if( this.start && this.stop ) {
                        if( d >= this.start.getTime() && d <= this.stop.getTime() ) {
                            filteredData.push(this.data[i]);
                        }
                    } else if ( this.start ) {
                        if( d >= this.start.getTime() ) {
                            filteredData.push(this.data[i]);
                        }
                    } else {
                        if( d <= this.stop.getTime()  ) {
                            filteredData.push(this.data[i]);
                        }
                    }
                }

                this._setDataTable(filteredData);
                this.redraw();
            },

            redraw : function() {
                if( !this.chart || !this.dt ) return;

                var options = {
                    legend : {
                        position : 'none'
                    }
                };

                if( !this.options ) {
                    options.vAxis = {};
                    options.hAxis = {};

                    if( this.label && this.label != '' ) {
                        options.title = this.label;
                    }
                    if( this.xlabel && this.xlabel != '' ) {
                        options.hAxis.title = this.xlabel;
                    }
                    if( this.ylabel && this.ylabel != '' ) {
                        options.vAxis.title = this.ylabel;
                    }
                } else {
                    for( var key in this.options ) {
                        options[key] = this.options[key];
                    }
                }


                this.chart.draw(this.dt, options);
            }
        });
    </script>
</polymer-element>