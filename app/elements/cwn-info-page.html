<polymer-element name="cwn-info-page" attributes="ds settings">
    <template>
        <style>
          .card {
            margin: 10px 10px 10px 10px;
            box-shadow: 0 0 5px #888;
            padding: 15px;
          }

          .back-btn {
            display: inline-block;

            color: #333 !important;
            background-color: #ccc;
            border-radius: 50px;
            font-size: 40px;
            padding: 0px 12px;
            margin: 10px;
            z-index: 100;
            cursor: pointer;
          }
          .desciption {
            font-size: 12px;
            color: #888;
          }
        </style>

        <a class="back-btn" on-click="{{back}}">
          <cwn-icon icon="fa-arrow-left" ></cwn-icon>
        </a>
        
        <div class="row" hidden?="{{ds.loading}}" >
          <div class="col-md-6">

            <div class="card">
              <div layout horizontal>
                <cwn-app-icon type="{{feature.properties.type}}" width="72" height="72" fillFromType="true" style="margin:15px"></cwn-app-icon>
                <div flex>
                  <h2>{{feature.properties.prmname}}</h2>
                  <div><b>{{feature.properties.type}}</b></div>
                </div>
              </div>
              <div style="padding: 10px; color: #888">
                {{feature.properties.description}}
              </div>
            </div>

          </div>
          <div class="col-md-6">
            <div class="card">
              <h4>Origins</h4>
              <div>
                <template bind if="{{feature.properties.origin != null}}">
                  <table class="table">
                    <tr>
                      <td>
                        <cwn-info-link name="{{feature.properties.origin}}" ds="{{ds}}"></cwn-info-link>
                      </td><td class="desciption">
                        <template bind if="{{ds.lookupMap[feature.properties.origin] != null}}">
                          {{ds.lookupMap[feature.properties.origin].properties.description}}
                        </template>
                      </td>
                    </tr>
                  </table>
                </template>

                <template bind if="{{feature.properties.origins.length > 0}}">
                  <table class="table">
                    <tr template repeat="{{origin in feature.properties.origins}}">
                      <td>
                        <cwn-info-link name="{{origin}}" ds="{{ds}}"></cwn-info-link>
                      </td><td class="desciption">
                        <template bind if="{{ds.lookupMap[origin] != null}}">
                          {{ds.lookupMap[origin].properties.description}}
                        </template>
                      </td>
                    </tr>
                  </table>
                </template>

              </div>

              <h4>Terminals</h4>
              <div>
                <template bind if="{{feature.properties.terminus != null}}">
                  <table class="table">
                    <tr>
                      <td>
                        <cwn-info-link name="{{feature.properties.terminus}}" ds="{{ds}}"></cwn-info-link>
                      </td><td class="desciption">
                        <template bind if="{{ds.lookupMap[feature.properties.terminus] != null}}">
                          {{ds.lookupMap[feature.properties.terminus].properties.description}}
                        </template>
                      </td>
                    </tr>
                  </table>
                </template>

                <template bind if="{{feature.properties.terminals.length > 0}}">
                  <table class="table">
                    <tr template repeat="{{terminal in feature.properties.terminals}}">
                      <td>
                        <cwn-info-link name="{{terminal}}" ds="{{ds}}"></cwn-info-link>
                      </td><td class="desciption">
                        <template bind if="{{ds.lookupMap[terminal] != null}}">
                          {{ds.lookupMap[terminal].properties.description}}
                        </template>
                      </td>
                    </tr>
                  </table>
                </template>

              </div>
            </div>
          </div>
        </div>

          <div class="row" hidden?="{{ds.loading}}">
            <div class="col-md-6">
              <div class="card">
                <h2 class="page-header">Climate</h2>

                <div class="alert alert-info" hidden?="{{feature.properties.hasClimate}}">
                  This node has no climate data associated with it.
                </div>
                <div class="alert alert-error" hidden?="{{!climateLoadError}}">
                  Error loading climate data.
                </div>
                <div hidden?="{{!climateLoading}}" style="color:#888">
                  Loading climate data...
                </div>

                <div hidden?="{{!feature.properties.hasClimate || climateLoadError || climateLoading}}">
                  <h4>Date Range</h4>

                  <cwn-dateslider id="dateslider" start="1920-01-01" on-values-changed="{{updateDateFilters}}"></cwn-dateslider>

                  <div hidden?="{{inflows.length == 0}}">
                    <h4>Inflows</h4>
                  </div>
                  <template repeat="{{inflow in inflows}}">
                    <cwn-date-linechart label="{{inflow.label}}" ylabel="Flow (kaf)" data="{{inflow.data}}" start="{{filters.start}}" stop="{{filters.stop}}"></cwn-date-linechart>
                  </template>
                  
                </div>
              </div>

            </div>

            <div class="col-md-6">
              <div class="card">
                <h2 class="page-header">Costs</h2>

                <div class="alert alert-info" hidden?="{{feature.properties.hasCosts}}">
                  This node has no cost data associated with it.
                </div>
                <div class="alert alert-error" hidden?="{{!costLoadError}}">
                  Error loading cost data.
                </div>
                <div hidden?="{{!costLoading}}" style="color:#888">
                  Loading cost data...
                </div>

                <template bind if="{{feature.properties.hasCosts && !costLoadError && !costLoading}}">
                  <template bind if="{{costs.label == 'Monthly Variable'}}">
                    <div class="btn-group">
                      <template repeat="{{month,i in costs.months}}">
                        <a class="btn btn-primary" index="{{i}}" disabled?="{{costs.selected == i}}" on-tap="{{_setCostMonth}}">{{month}}</a>
                      </template>
                    </div>

                    <cwn-linechart label="{{costs.label}} - {{costs.months[costs.selected]}}" xlabel="Capacity (kAF)" ylabel="Cost ($/kAF)" data="{{costs.data[costs.months[costs.selected]]}}" animate></cwn-linechart>
                  </template>

                  <template bind if="{{costs.label == 'Constant'}}">
                    <h5>Constant: ${{costs.cost}}</h5>
                  </template>

                  <template bind if="{{costs.label != 'Constant' && costs.label != 'Monthly Variable'}}">
                    <div><b>{{costs.label}}</b>: Not implemented yet</div>
                  </template>
                </template>
              </div>
            </div>
          </div>
 
      
    </template>
    <script>
        Polymer('cwn-info-page', {
            feature : {},

            tableProperties : ['prmname'],

            // loading flags
            climateLoadError : false,
            costLoadError : false,
            climateLoading : false,
            costLoading : false,

            // render data.  Data in a format ready to draw above
            inflows : [],
            costs : {
              label : '',
              data : {},
              cost : 0, // for constant costs
              months : [],
              selected : 0
            },

            // date filtering
            filters : {
              start : null,
              stop : null
            },

            observe : {
                feature : 'update',
                'ds.loading' : 'onLoad'
            },

            onLoad : function() {
              if( this.ds.loading ) return;

              var loc = window.location.hash.replace('#','').split('/');
              if( loc[0] == 'info' && loc.length > 1) {
                this.feature = this.ds.lookupMap[loc[1]];
              }
            },

            update : function() {
              if( this.feature == null ) return alert('Feature not found');

              // reset flags
              this.climateLoadError = false;
              this.costLoadError = false;
              this.climateLoading = false;
              this.costLoading = false;

              this.loadClimateData();
              this.loadCostData();

            },

            loadClimateData : function() {
              if( !this.feature.properties.hasClimate ) return;
              this.climateLoading = true;
              this.inflows = [];

              $.ajax({
                  type : 'POST',
                  url : this.settings.neo4jUrl+'/cypher',
                  data : {
                      query : 'MATCH (n { prmname: "'+this.feature.properties.prmname+'" }) RETURN n.climate',
                      params : {}
                  },
                  success : function(resp) {
                    this.climateLoading = false;
                    if( resp.data.length == 0 ) return this.climateLoadError = true;

                    this.renderClimateData(JSON.parse(resp.data[0][0]));
                    this.async(function(){
                      this.$.dateslider.resize();
                    });
                  }.bind(this),
                  error : function(resp) {
                    this.climateLoadError = true;
                  }.bind(this)
              });
            },

            renderClimateData : function(data) {

              if( data.inflows ) {
                for( var i = 0; i < data.inflows.length; i++ ) {
                  var inflow = {
                    label : data.inflows[i].name,
                    data : []
                  };
                  for( var j = 0; j < data.inflows[i].date.length; j++ ) {
                    inflow.data.push([data.inflows[i].date[j], data.inflows[i].inflow[j]]);
                  }
                  this.inflows.push(inflow);
                }
              }

            },

            loadCostData : function() {
              if( !this.feature.properties.hasCosts ) return;
              this.costLoading = true;
              this.costLoadError = false;

              var query;
              if( this.feature.properties.type == 'Diversion' ) {
                query = 'MATCH (n)-[r { prmname: "'+this.feature.properties.prmname+'" }]->() RETURN r.costs';
              } else {
                query ='MATCH (n { prmname: "'+this.feature.properties.prmname+'" }) RETURN n.costs';
              }

              $.ajax({
                  type : 'POST',
                  url : this.settings.neo4jUrl+'/cypher',
                  data : {
                      query : query,
                      params : {}
                  },
                  success : function(resp) {
                    this.costLoading = false;
                    if( resp.data.length == 0 ) return this.costLoadError = true;

                    this.renderCostData(JSON.parse(resp.data[0][0]));
                  }.bind(this),
                  error : function(resp) {
                    this.costLoadError = true;
                  }.bind(this)
              });
            },

            renderCostData : function(d) {
              this.costs.label = d.costs.type;
              this.costs.data = {};
              this.costs.months = [];
              this.costs.selected = 0;

              this.costs.cost = d.costs.cost;

              if( !d.costs.costs ) return;
              if( d.costs.costs.length == 0 ) return;

              for( var i = 0; i < d.costs.costs.length; i++ ) {
                var m = d.costs.costs[i];

                this.costs.data[m.label] = [];
                this.costs.months.push(m.label);

                for( var j = 0; j < m.costs.length; j++ ) {
                  this.costs.data[m.label].push([
                    m.costs[j].capacity,
                    m.costs[j].cost
                  ]);
                }

                this.costs.data[m.label].sort(function(a, b){
                  if( a[0] > b[0] ) return 1;
                  if( a[0] < b[0] ) return -1;
                  return 0;
                });
                this.costs.data[m.label].splice(0,0, ['Capacity','Cost']);

              }

            },

            updateDateFilters : function(e) {
              this.filters.start = e.detail.start;
              this.filters.stop = e.detail.end;
            },  

            back : function() {
              window.location.hash = 'map'
            },

            _setCostMonth : function(e) {
              var index = parseInt(e.currentTarget.getAttribute('index'));
              this.costs.selected = index;
            }

        });
    </script>
</polymer-element>