<polymer-element name="cwn-info-page" attributes="ds settings leaflet">
    <template>
        <style>
          :host {
            display: block;
            overflow-x: hidden;
          }
          .card {
            margin: 10px 10px 10px 10px;
            box-shadow: 0 0 5px #888;
            padding: 15px;
          }

          .back-btn {
            display: inline-block;

            color: #333 !important;
            background-color: #ccc;
            border-radius: 50px;
            font-size: 40px;
            padding: 0px 12px;
            margin: 10px;
            z-index: 100;
            cursor: pointer;
          }
          .description {
            font-size: 12px;
            color: #888;
          }
          .border {
            padding: 5px;
            display: inline-block;
            border-radius: 6px;
            border: 1px solid #eee;
            margin-top: 25px;
          }
          #middleCol {
            transition: margin-top linear 200ms;
            -webkit-transition: margin-top linear 200ms;
            -moz-transition: margin-top linear 200ms;
            -ms-transition: margin-top linear 200ms;
          }
        </style>

        <a class="back-btn" on-click="{{back}}">
          <cwn-icon icon="fa-arrow-left" ></cwn-icon>
        </a>

      <div class="card" hidden?="{{ds.loading}}">
        <div class="row" >
          <div class="col-md-4 no-float">

            <h4 class="page-header" style="text-align:right">Origins</h4>
            <div>

              <template bind if="{{feature.properties.origin != null}}">
                <div style="text-align:right">
                  <div>
                    <cwn-info-link name="{{feature.properties.origin}}" ds="{{ds}}"></cwn-info-link>
                  </div>
                  <template bind if="{{ds.lookupMap[feature.properties.origin] != null}}">
                    <div class="description">{{ds.lookupMap[feature.properties.origin].properties.description}}</div>
                  </template>
                </div>
              </template>

              <template bind if="{{origins.length > 0}}">
                <template repeat="{{origin in origins}}">
                  <div style="text-align:right;margin-bottom:20px">
                    <div>
                      <cwn-info-link name="{{origin.name}}" ds="{{ds}}"></cwn-info-link>&nbsp;&nbsp;&nbsp;

                      <template bind if="{{origin.link != ''}}">
                        <a href="{{hack}}#info/{{origin.link}}"><cwn-icon icon="fa-long-arrow-right" style="font-size:32px;display:inline-block;margin-top:-15px"></cwn-icon></a>
                      </template>
                      <template bind if="{{origin.link == ''}}">
                        <cwn-icon icon="fa-long-arrow-right" style="color:#888;font-size:32px;display:inline-block;margin-top:-15px"></cwn-icon>
                      </template>

                    </div>
                    <template bind if="{{origin.description != ''}}">
                      <div class="description" style="margin: -10px 55px 0 0">{{origin.description}}</div>
                    </template>
                  </div>
                </template>
              </template>

            </div>

          </div>
          <div class="col-md-4" style="text-align:center" id="middleCol">
          
            
              <div class="border">
                <table style="margin: 0 auto">
                  <tr>
                    <td>
                      <cwn-app-icon type="{{feature.properties.type}}" width="72" height="72" fillFromType="true" style="margin:35px 15px 0 15px"></cwn-app-icon>
                    </td><td>
                      <h2>{{feature.properties.prmname}}</h2>
                      <div><b>{{feature.properties.type}}</b></div>
                    </td>
                  </tr>
                </table>
                <div style="padding: 10px 10px 0 10px; color: #888">
                  {{feature.properties.description}}
                </div>
                <div hidden?="{{feature.properties.type == 'Diversion'}}">
                  <a class="btn btn-link" on-click="{{goTo}}"><cwn-icon icon="fa-map-marker"></cwn-icon> Show on Map</a>
                </div>
              </div>
            

          </div>
          <div class="col-md-4">

            <h4 class="page-header">Terminals</h4>

            <template bind if="{{feature.properties.terminus != null}}">
              <div>
                <cwn-info-link name="{{feature.properties.terminus}}" ds="{{ds}}"></cwn-info-link>
              </div>
              <template bind if="{{ds.lookupMap[feature.properties.terminus] != null}}">
                <div class="description">{{ds.lookupMap[feature.properties.terminus].properties.description}}</div>
              </template>
            </template>

            <template bind if="{{terminals.length > 0}}">
              <template repeat="{{terminal in terminals}}">
                <div style="margin-bottom:20px">
                  <div>
                    <template bind if="{{terminal.link != ''}}">
                      <a href="{{hack}}#info/{{terminal.link}}"><cwn-icon icon="fa-long-arrow-right" style="font-size:32px;display:inline-block;margin-top:-15px"></cwn-icon></a>
                    </template>
                    <template bind if="{{terminal.link == ''}}">
                      <cwn-icon icon="fa-long-arrow-right" style="color:#888;font-size:32px;display:inline-block;margin-top:-15px"></cwn-icon>
                    </template>

                    &nbsp;&nbsp;&nbsp;<cwn-info-link name="{{terminal.name}}" ds="{{ds}}"></cwn-info-link>

                  </div>
                  <template bind if="{{terminal.description != ''}}">
                    <div class="description" style="margin: -10px 0 0 55px">{{terminal.description}}</div>
                  </template>
                </div>
              </template>
            </template>

          </div>
        </div>
      </div>

      <div hidden?="{{!(inflows.length > 0 || constraintChart.isTimeSeries)}}">
        <div style="padding:20px 50px 5px 50px">
          <h4>Date Range</h4>
          <cwn-dateslider 
            id="dateslider" 
            start="1920-01-01" 
            on-values-changed="{{updateDateFilters}}">
          </cwn-dateslider>
        </div>
      </div>

          <div class="row" hidden?="{{ds.loading}}">
            <div class="col-md-6">
              <div class="card">
                <h2 class="page-header">Climate</h2>

                <div class="alert alert-info" hidden?="{{feature.properties.hasClimate}}">
                  This node has no climate data associated with it.
                </div>
                <div class="alert alert-error" hidden?="{{!climateLoadError}}">
                  Error loading climate data.
                </div>
                <div hidden?="{{!climateLoading}}" style="color:#888">
                  Loading climate data...
                </div>

                <div hidden?="{{!feature.properties.hasClimate || climateLoadError || climateLoading}}">

                  <div hidden?="{{inflows.length == 0}}">
                    <h4>Inflows</h4>
                  </div>
                  <template repeat="{{inflow in inflows}}">
                    <cwn-date-linechart label="{{inflow.label}}" ylabel="Flow (kaf)" data="{{inflow.data}}" start="{{filters.start}}" stop="{{filters.stop}}"></cwn-date-linechart>
                  </template>

                  <template bind if="{{eacChart.data.length > 0}}">
                    <h4>Elevation / Area / Capacity</h4>
                    <cwn-linechart
                      data="{{eacChart.data}}"
                      cols="{{eacChart.cols}}"
                      options="{{eacChart.options}}"
                      type="{{eacChart.type}}">
                    </cwn-linechart>
                  </template>
                  
                </div>
              </div>

            </div>

            <div class="col-md-6">
              <div class="card">
                <h2 class="page-header">Costs</h2>

                <div class="alert alert-info" hidden?="{{feature.properties.hasCosts}}">
                  This node has no cost data associated with it.
                </div>
                <div class="alert alert-error" hidden?="{{!costLoadError}}">
                  Error loading cost data.
                </div>
                <div hidden?="{{!costLoading}}" style="color:#888">
                  Loading cost data...
                </div>

                <template bind if="{{feature.properties.hasCosts && !costLoadError && !costLoading}}">
                  <template bind if="{{costs.label == 'Monthly Variable'}}">
                    <div class="btn-group">
                      <template repeat="{{month,i in costs.months}}">
                        <a class="btn btn-xs btn-primary" index="{{i}}" disabled?="{{costs.selected == i}}" on-tap="{{_setCostMonth}}">{{month}}</a>
                      </template>
                    </div>

                    <cwn-linechart label="{{costs.label}} - {{costs.months[costs.selected]}}" xlabel="Capacity (kAF)" ylabel="Cost ($/kAF)" data="{{costs.data[costs.months[costs.selected]]}}" animate></cwn-linechart>
                  </template>

                  <template bind if="{{costs.label == 'Constant'}}">
                    <h5>Constant: ${{costs.cost}}</h5>
                  </template>
<!--
                  <template bind if="{{costs.label != 'Constant' && costs.label != 'Monthly Variable'}}">
                    <div><b>{{costs.label}}</b>: Not implemented yet</div>
                  </template> -->
                </template>


                <h4 hidden?="{{constraintChart.data.length == 0 && constraintChart.constant == -1}}">Constraints</h4>

                <h5 hidden?="{{constraintChart.constant == -1}}">
                  Constant: ${{constraintChart.constant}}
                </h5>

                <template bind if="{{constraintChart.data.length > 0}}">
                  <template bind if="{{constraintChart.isTimeSeries}}">
                    <cwn-date-linechart
                      data="{{constraintChart.data}}"
                      cols="{{constraintChart.cols}}"
                      options="{{constraintChart.options}}"
                      start="{{filters.start}}" 
                      stop="{{filters.stop}}">
                    </cwn-date-linechart>
                  </template>

                  <template bind if="{{!constraintChart.isTimeSeries}}">
                    <cwn-linechart
                      data="{{constraintChart.data}}"
                      cols="{{constraintChart.cols}}"
                      options="{{constraintChart.options}}">
                    </cwn-linechart>
                  </template>
                </template>

              </div>
            </div>
          </div>
 
      
    </template>
    <script>
        Polymer('cwn-info-page', {
            feature : {},

            hack : '',

            tableProperties : ['prmname'],

            // loading flags
            climateLoadError : false,
            costLoadError : false,
            climateLoading : false,
            costLoading : false,

            // have to do long lookup right now, is there are better way?
            origins : [],
            terminals : [],

            // render data.  Data in a format ready to draw above
            inflows : [],
            costs : {
              label : '',
              data : {},
              cost : 0, // for constant costs
              months : [],
              selected : 0
            },
            // Elevation / Area / Capacity charts
            eacChart : {
              type : 'ComboChart',
              cols : [
                {id: 'capacity', label: 'capacity', type: 'number'},
                {id: 'elevation', label: 'elevation', type: 'number'},
                {id: 'area', label: 'area', type: 'number'},
                {id: 'initial', type: 'number', label: 'initial'},
                {id: 'tooltip', type: 'string', role:'tooltip'}
              ],
              data : [],
              options : {
                hAxis : {
                  title : 'Capacity (kAF)'
                },
                vAxes : [
                  {title:'Elevation (ft)'}, // axis 0
                  {title:'Area (ac)'} // Axis 1
                ],
                seriesType: "bars",
                series :{
                  0: {type: "line", targetAxisIndex:0},
                  1: {type: "line", targetAxisIndex:1},
                  2: {targetAxisIndex: 0},
                },
                interpolateNulls : true,
                legend : {
                  position: 'top'
                }
              }
            },

            constraintChart : {
              constant: -1,
              label : '',
              isTimeSeries : false,
              cols : [
                {id:'date', type:'string'},
                {id:'upper_value', type:'number'},
                {id:'upper_interval', type:'number', role:'interval'},
                {id:'lower_interval', type:'number', role:'interval'},
                {id: 'tooltip', type: 'string', role:'tooltip'}
              ],
              data : [],
              options : {
                series: [{'color': '#F1CA3A'}],
                intervals: { 'style':'area' },
                vAxis : {
                  viewWindow:{ min: 0 }
                }
              }
            },

            months : ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],

            // date filtering
            filters : {
              start : null,
              stop : null
            },

            observe : {
                feature : 'update',
                'ds.loading' : 'onLoad'
            },

            ready : function() {
              $(window).on('resize', this._updateSize.bind(this));
            },

            onLoad : function() {
              if( this.ds.loading ) return;

              var loc = window.location.hash.replace('#','').split('/');
              if( loc[0] == 'info' && loc.length > 1) {
                this.feature = this.ds.lookupMap[loc[1]];
              }

            },

            _updateSize : function() {
              var w = $(window).width();

              if( w < 992 ) {
                this.$.middleCol.style.marginTop = '0px';
                return;
              }
              
              var ele = $(this.$.middleCol);
              
              var h = ele.next().height();
              if( h < ele.prev().height() ) h = ele.prev().height();
              if( h < ele.height() ) h = ele.height();


              this.$.middleCol.style.marginTop = Math.floor(((h-ele.height()) / 2)) + 'px';
              
            },

            _lookupLink : function(origin, terminal) {
              for( var i = 0; i < this.ds.data.links.length; i++ ) {
                if( this.ds.data.links[i].properties.origin == origin && this.ds.data.links[i].properties.terminus == terminal ) {
                  return this.ds.data.links[i];
                }
              }
              return null;
            },

            update : function() {
              if( this.feature == null ) return alert('Feature not found');


              this.origins = [];
              this.terminals = [];

              var link;
              if( this.feature && this.feature.properties.origins ) {
                for( var i = 0; i < this.feature.properties.origins.length; i++ ) {
                  link = this._lookupLink(this.feature.properties.origins[i], this.feature.properties.prmname);
                  if( link ) {
                    this.origins.push({
                      name: this.feature.properties.origins[i], 
                      link: link.properties.prmname,
                      description: this.ds.lookupMap[this.feature.properties.origins[i]] ? 
                                    this.ds.lookupMap[this.feature.properties.origins[i]].properties.description : ''
                    });
                  } else {
                    this.origins.push({name: this.feature.properties.origins[i], link: '', description: ''});
                  }
                }
              }

              if( this.feature && this.feature.properties.terminals ) {
                for( var i = 0; i < this.feature.properties.terminals.length; i++ ) {
                  link = this._lookupLink(this.feature.properties.prmname, this.feature.properties.terminals[i]);
                  if( link ) {
                    this.terminals.push({
                      name: this.feature.properties.terminals[i], 
                      link: link.properties.prmname,
                      description: this.ds.lookupMap[this.feature.properties.terminals[i]] ? 
                                    this.ds.lookupMap[this.feature.properties.terminals[i]].properties.description : ''
                    });
                  } else {
                    this.terminals.push({name: this.feature.properties.terminals[i], link: '', description: ''});
                  }
                }
              }

              this.climateLoadError = false;
              this.costLoadError = false;
              this.climateLoading = false;
              this.costLoading = false;

              this.eacChart.data = [];
              this.constraintChart.data = [];
              this.constraintChart.isTimeSeries = false;
              this.constraintChart.constant = -1;
              this.constraintChart.label = '';

              this.loadClimateData();
              this.loadCostData();

              setTimeout(this._updateSize.bind(this), 100);
            },

            loadClimateData : function() {
              if( !this.feature.properties.hasClimate ) return;
              this.climateLoading = true;
              this.inflows = [];

              var query;
              if( this.feature.properties.type == 'Diversion' || this.feature.properties.type == 'Return Flow' ) {
                query = 'MATCH (n)-[r { prmname: "'+this.feature.properties.prmname+'" }]->() RETURN r.climate';
              } else {
                query ='MATCH (n { prmname: "'+this.feature.properties.prmname+'" }) RETURN n.climate';
              }

              $.ajax({
                  type : 'POST',
                  url : this.settings.neo4jUrl+'/cypher',
                  data : {
                      query : query,
                      params : {}
                  },
                  success : function(resp) {
                    this.climateLoading = false;
                    if( resp.data.length == 0 ) return this.climateLoadError = true;

                    this.renderClimateData(JSON.parse(resp.data[0][0]));
//                    this.async(function(){
//                     this.$.dateslider.resize();
//                    });
                  }.bind(this),
                  error : function(resp) {
                    this.climateLoadError = true;
                  }.bind(this)
              });
            },

            renderClimateData : function(data) {

              if( data.inflows ) {
                for( var i = 0; i < data.inflows.length; i++ ) {
                  var inflow = {
                    label : data.inflows[i].name,
                    data : []
                  };
                  for( var j = 0; j < data.inflows[i].date.length; j++ ) {
                    inflow.data.push([data.inflows[i].date[j], data.inflows[i].inflow[j]]);
                  }
                  this.inflows.push(inflow);
                }
              }

              this.eacChart.data = [];
              if( data.el_ar_cap ) {
                
                var max = 0;
                for( var i = 0; i < data.el_ar_cap.length; i++ ) {
                  this.eacChart.data.push([
                    data.el_ar_cap[i].capacity,
                    data.el_ar_cap[i].elevation,
                    data.el_ar_cap[i].area,
                    null,
                    null
                  ]);
                  if( data.el_ar_cap[i].elevation > max ) max = data.el_ar_cap[i].elevation;
                }

                if( this.feature.properties.initialstorage ) {
                  this.eacChart.data.push([
                    this.feature.properties.initialstorage,
                    null,
                    null,
                    max,
                    'Initial: '+this.feature.properties.initialstorage
                  ]);
                }

                this.eacChart.data.sort(function(a,b){
                  if( a[0] > b[0] ) return 1;
                  if( a[0] < b[0] ) return -1;
                  return 0;
                });
              }



            },

            loadCostData : function() {
              if( !this.feature.properties.hasCosts ) return;
              this.costLoading = true;
              this.costLoadError = false;

              var query;
              if( this.feature.properties.type == 'Diversion' || this.feature.properties.type == 'Return Flow' ) {
                query = 'MATCH (n)-[r { prmname: "'+this.feature.properties.prmname+'" }]->() RETURN r.costs';
              } else {
                query ='MATCH (n { prmname: "'+this.feature.properties.prmname+'" }) RETURN n.costs';
              }

              $.ajax({
                  type : 'POST',
                  url : this.settings.neo4jUrl+'/cypher',
                  data : {
                      query : query,
                      params : {}
                  },
                  success : function(resp) {
                    this.costLoading = false;
                    if( resp.data.length == 0 ) return this.costLoadError = true;

                    this.renderCostData(JSON.parse(resp.data[0][0]));
                  }.bind(this),
                  error : function(resp) {
                    this.costLoadError = true;
                  }.bind(this)
              });
            },

            renderCostData : function(d) {
              if( d.constraints ) this.renderConstraints(d.constraints);

              if( !d.costs ) return;

              this.costs.label = d.costs.type;
              this.costs.data = {};
              this.costs.months = [];
              this.costs.selected = 0;

              this.costs.cost = d.costs.cost;

              if( !d.costs.costs ) return;
              if( d.costs.costs.length == 0 ) return;

              for( var i = 0; i < d.costs.costs.length; i++ ) {
                var m = d.costs.costs[i];

                var label = m.label;
                if( (!label || label == '') && i < 12 ) label = this.months[i];

                this.costs.data[label] = [];
                this.costs.months.push(label);

                for( var j = 0; j < m.costs.length; j++ ) {
                  this.costs.data[label].push([
                    m.costs[j].capacity,
                    m.costs[j].cost
                  ]);
                }

                this.costs.data[label].sort(function(a, b){
                  if( a[0] > b[0] ) return 1;
                  if( a[0] < b[0] ) return -1;
                  return 0;
                });
                this.costs.data[label].splice(0,0, ['Capacity','Cost']);

              }

            },

            renderConstraints : function(constraints) {
              console.log(constraints);


              if( constraints.constraint_type == 'Bounded' ) {
                var length = this.getContraintsLength(constraints);
                if( length < 12 ) length = 12;

                for( var i = 0; i < length; i++ ) {
                  this.constraintChart.data.push(this.getConstraintRow(constraints, i));
                }

              } else if( constraints.constraint_type == 'Constrained' ) {

                if( constraints.constraint.bound_type == 'Constant') {
                  this.constraintChart.constant = constraints.constraint.bound;
                } else if( constraints.constraint.bound_type == 'Monthly') {
                  for( var i = 0; i < 12; i++ ) {
                    this.constraintChart.data.push([
                      this.months[i],
                      constraints.constraint.bound[i],
                      null,
                      null,
                      'Constrained: '+constraints.constraint.bound[i]
                    ]);
                  }
                } if( constraints.constraint.bound_type == 'TimeSeries') {

                  this.constraintChart.isTimeSeries = true;
                  for( var i = 0; i < constraints.constraint.bound.length; i++ ) {
                    this.constraintChart.data.push([
                      constraints.constraint.date[i],
                      constraints.constraint.bound[i],
                      null,
                      null,
                      'Constrained: '+constraints.constraint.bound[i]
                    ]);
                  }

                }

              } else {
                console.log('Unknown Constraint Type: '+constraints.constraint_type);
              }
            },

            getConstraintRow : function(constraints, index) {
              var row = [];

              if( constraints.lower && constraints.lower.bound_type == 'TimeSeries' ) {
                row.push(constraints.lower.date[index]);
              } else if ( constraints.upper && constraints.upper.bound_type == 'TimeSeries' ) {
                row.push(constraints.upper.date[index]);
              } else {
                row.push(this.months[index]);
              }

              var tooltip = row[0]+'\n';

              if( constraints.upper ) {
                if( constraints.upper.bound_type == 'Constant' ) {
                  row.push(constraints.upper.bound);
                  row.push(constraints.upper.bound);
                  tooltip += 'Upper: '+constraints.upper.bound;
                } else if ( constraints.upper.bound_type == 'TimeSeries' || constraints.upper.bound_type == 'Monthly') {
                  var i = index;
                  if( i > 11 && constraints.upper.bound_type == 'Monthly' ) {
                    i = parseInt(row[0].split("-")[1])-1;
                  }

                  row.push(constraints.upper.bound[i]);
                  row.push(constraints.upper.bound[i]);
                  tooltip += 'Upper: '+constraints.upper.bound[i];
                } else if ( constraints.upper.bound_type == 'None' ) {
                  tooltip += 'Upper: None';
                }
              }

              if( constraints.lower ) {

                if( constraints.lower.bound_type == 'Constant' ) {
                  row.push(constraints.lower.bound);
                  tooltip += ', Lower: '+constraints.lower.bound;
                } else if ( constraints.lower.bound_type == 'TimeSeries' || constraints.lower.bound_type == 'Monthly' ) {
                  var i = index;
                  if( i > 11 && constraints.upper.bound_type == 'Monthly' ) {
                    i = parseInt(row[0].split("-")[1])-1;
                  }

                  row.push(constraints.lower.bound[i]);
                  tooltip += ', Lower: '+constraints.lower.bound[i];
                } else if ( constraints.lower.bound_type == 'None' ) {
                  row.push(0);
                  tooltip += ', Lower: 0';
                } else {
                   tooltip += ', Lower: Unknown';
                }

              } 

              while(row.length < 4) row.push(null);

              row.push(tooltip);

              return row;
            },

            getContraintsLength : function(constraints) {
              var l = 0;
              if( constraints.lower ) {
                if( constraints.lower.bound_type == 'Constant' ) {
                  l = 1;
                } else if ( constraints.lower.bound_type == 'TimeSeries' ) {
                  this.constraintChart.isTimeSeries = true;
                  l = constraints.lower.bound.length;
                } else if ( constraints.lower.bound_type == 'Monthly' ) {
                  l = constraints.lower.bound.length;
                }
              }
              if (constraints.upper ) {
                if( constraints.upper.bound_type == 'Constant' && l == 0 ) {
                  l = 1;
                } else if(constraints.upper.bound_type == 'TimeSeries' && l < constraints.upper.bound.length ) {
                  this.constraintChart.isTimeSeries = true;
                  l = constraints.upper.bound.length;
                } else if ( constraints.upper.bound_type == 'Monthly' && l < constraints.upper.bound.length ) {
                  l = constraints.upper.bound.length;
                }
              }
              return l;
            },

            updateDateFilters : function(e) {
              this.filters.start = e.detail.start;
              this.filters.stop = e.detail.end;
            },  

            back : function() {
              window.location.hash = 'map'
            },

            _setCostMonth : function(e) {
              var index = parseInt(e.currentTarget.getAttribute('index'));
              this.costs.selected = index;
            },

            goTo : function() {
              window.location.hash = 'map';
              this.async(function() {
                var pts = this.feature.geometry.coordinates;
                this.leaflet.setView([pts[1], pts[0]], 12);
              });
            }

        });
    </script>
</polymer-element>