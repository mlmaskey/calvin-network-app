<dom-module id="cwn-node-info">
    <style>
        #middleCol {
            transition: margin-top linear 200ms;
            -webkit-transition: margin-top linear 200ms;
            -moz-transition: margin-top linear 200ms;
            -ms-transition: margin-top linear 200ms;
        }
        cwn-node-info {
            display: block;
        }
    </style>

    <template>
        <div class="row" >

          <!-- Start Origins -->
          <div class="col-md-4 no-float">
            <h4 class="page-header" style="text-align:right">Origins</h4>
            <div>

              <div id="origin">
                <div style="text-align:right">
                  <div>
                    <cwn-info-link name="{{feature.properties.origin}}"></cwn-info-link>
                  </div>
                  <div hidden$="{{!hasOriginDescription}}">
                    <div class="description">{{originDescription}}</div>
                  </div>
                </div>
              </div>


              <template is="x-repeat" items="{{origins}}">
                <div style="text-align:right;margin-bottom:20px">
                  <div>
                    <cwn-info-link name="{{item.name}}" style="vertical-align:top"></cwn-info-link>&nbsp;&nbsp;&nbsp;

                    <a href="{{origin.link}}" hidden$="{{!item.hasLink}}">
                      <i class="fa fa-long-arrow-right" style="font-size:32px;display:inline-block;"></i>
                    </a>

                    <span hidden$="{{item.hasLink}}">
                        <i class="fa fa-long-arrow-right" style="color:#888;font-size:32px;display:inline-block;"></i>
                    </span>

                  </div>
                  <div class="description" hidden$="{{!origin.description}}" style="margin: -10px 55px 0 0">{{origin.description}}</div>
                </div>
              </template>
            </div>
          </div>
          <!-- End Origins -->

          <!-- Start Feature -->
          <div class="col-md-4" style="text-align:center" id="middleCol">
              <div class="border">
                <table style="margin: 0 auto">
                  <tr>
                    <td>
                      <cwn-app-icon type="{{feature.properties.type}}" width="72" height="72" fillFromType="true" style="margin:35px 15px 0 15px"></cwn-app-icon>
                    </td><td>
                      <h2>{{feature.properties.prmname}}</h2>
                      <div><b>{{feature.properties.type}}</b></div>
                    </td>
                  </tr>
                </table>
                <div style="padding: 10px 10px 0 10px; color: #888">{{feature.properties.description}}</div>
                <div hidden$="{{!showNavLinks}}">
                  <div><a class="btn btn-link" on-click="goToGraph"><i class="fa fa-code-fork"></i> View Network Graph</a></div>
                  <div><a class="btn btn-link" on-click="goTo"><i class="fa fa-map-marker"></i> Show on Map</a></div>
                </div>
                <div hidden$="{{!islocal}}">
                    <div>
                      <a class="btn btn-link" href="{{editUrl}}">
                      <i class="fa fa-pencil"></i> Edit</a>
                    </div>
                </div>
              </div>
          </div>
          <!-- End Feature -->

          <!-- Start Terminals -->
          <div class="col-md-4">
            <h4 class="page-header">Terminals</h4>

            <div id="terminal">
              <div>
                <cwn-info-link name="{{feature.properties.terminus}}" ds="{{ds}}"></cwn-info-link>
              </div>
              <div hidden$="{{hasTerminalDescription}}">
                <div class="description">{{terminalDescription}}</div>
              </div>
            </div>

            <template is="x-repeat" items="{{terminals}}">
              <div style="margin-bottom:20px">
                <div>

                  <a href="{{item.link}}" hidden$="{{!item.hasLink}}">
                    <i class="fa fa-long-arrow-right" style="font-size:32px;display:inline-block;"></i>
                  </a>

                  <span hidden$="{{item.hasLink}}">
                      <i class="fa fa-long-arrow-right" style="color:#888;font-size:32px;display:inline-block;"></i>
                  </span>

                  &nbsp;&nbsp;&nbsp;<cwn-info-link name="{{item.name}}" style="vertical-align:top"></cwn-info-link>

                </div>
                <div hidden$="{{!item.description}}">
                  <div class="description" style="margin: -10px 0 0 55px">{{item.description}}</div>
                </div>
              </div>
            </template>
          </div>
          <!-- End Terminals -->

        </div>
    </template>
</dom-module>

<script>
    Polymer({
        is : 'cwn-node-info',

        published : {
            feature : {
                type : Object
            },
            ds : {
                type : Object
            }
        },

        bind : {
            'feature.properties.origin' : 'onOriginUpdate',
            'feature.properties.terminal' : 'onTerminalUpdate',
            'feature.properties.type' : 'onTypeUpdate',
            'feature' : 'update'
        },

        configure : function() {
            return {
                hasOriginDescription : false,
                originDescription : '',
                editUrl : '',
                originUrl : '',
                terminalUrl : '',
                showNavLinks : false,
                hasTerminalDescription : false,
                terminalDescription : '',
                origins : [],
                terminals : []
            }
        },

        ready : function() {
            $(window).on('resize', this.updateSize.bind(this));
        },

        update : function() {
            if( !this.ds ) return;

            this.editUrl = '#edit/'+this.feature.properties.prmname;

            this.origins = [];
            this.terminals = [];

            var link;
            if( this.feature && this.feature.properties.origins ) {
                for( var i = 0; i < this.feature.properties.origins.length; i++ ) {
                  link = this._lookupLink(this.feature.properties.origins[i], this.feature.properties.prmname);
                  if( link ) {
                    this.origins.push({
                      name: this.feature.properties.origins[i], 
                      link: '#info/'+link.properties.prmname,
                      hasLink : true, 
                      description: this.ds.lookupMap[this.feature.properties.origins[i]] ? 
                                    this.ds.lookupMap[this.feature.properties.origins[i]].properties.description : ''
                    });
                  } else {
                    this.origins.push({
                        name: this.feature.properties.origins[i],
                        hasLink : false, 
                        link: '', 
                        description: ''
                    });
                  }
                }
            }

            console.log(this.origins)

            if( this.feature && this.feature.properties.terminals ) {
                for( var i = 0; i < this.feature.properties.terminals.length; i++ ) {
                  link = this._lookupLink(this.feature.properties.prmname, this.feature.properties.terminals[i]);
                  if( link ) {
                    this.terminals.push({
                      name: this.feature.properties.terminals[i], 
                      link: '#info/'+link.properties.prmname,
                      hasLink : true, 
                      description: this.ds.lookupMap[this.feature.properties.terminals[i]] ? 
                                    this.ds.lookupMap[this.feature.properties.terminals[i]].properties.description : ''
                    });
                  } else {
                    this.terminals.push({
                        name: this.feature.properties.terminals[i], 
                        link: '', 
                        description: '',
                        hasLink : false, 
                    });
                  }
                }
            }

            $(window).on('resize', this.updateSize.bind(this));
        },

        onOriginUpdate : function() {
            if( !this.ds ) return;

            if( !this.feature.properties.origin ) return this.$.origin.style.display = 'none'; 
            else this.$.origin.style.display = 'block'; 

            this.hasOriginDescription = false;
            this.originDescription = '';

            if( this.ds.lookupMap[this.feature.properties.origin] ) {
                this.hasOriginDescription = true;
                this.originDescription = this.ds.lookupMap[this.feature.properties.origin].properties.description
            }
        },

        onTerminalUpdate : function() {
            if( !this.ds ) return;

            if( !this.feature.properties ) return this.$.terminal.style.display = 'none'; 
            else this.$.terminal.style.display = 'block'; 

            this.hasTerminalDescription = false;
            this.terminalDescription = '';

            if( this.ds.lookupMap[this.feature.properties.terminal] ) {
                this.hasTerminalDescription = true;
                this.terminalDescription = this.ds.lookupMap[this.feature.properties.terminal].properties.description
            }
        },

        onTypeUpdate : function() {
            if( !this.ds ) return;

            this.showNavLinks = true;

            if( this.feature.properties.type == 'Diversion' || this.feature.properties.type == 'Return Flow' ) {
                this.showNavLinks = false;
            }
        },

        _lookupLink : function(origin, terminal) {
          for( var i = 0; i < this.ds.data.links.length; i++ ) {
            if( this.ds.data.links[i].properties.origin == origin && this.ds.data.links[i].properties.terminus == terminal ) {
              return this.ds.data.links[i];
            }
          }
          return null;
        },

        updateSize : function() {
          var w = $(window).width();

          if( w < 992 ) {
            this.$.middleCol.style.marginTop = '0px';
            return;
          }
          
          var ele = $(this.$.middleCol);
          
          var h = ele.next().height();
          if( h < ele.prev().height() ) h = ele.prev().height();
          if( h < ele.height() ) h = ele.height();


          this.$.middleCol.style.marginTop = Math.floor(((h-ele.height()) / 2)) + 'px';
        },

        goTo : function() {
          window.location.hash = 'map';
          this.async(function() {
            var pts = this.feature.geometry.coordinates;
            this.leaflet.setView([pts[1], pts[0]], 12);
          });
        },

        goToGraph : function() {
          window.location.hash = 'graph/'+this.feature.properties.prmname;
        }
    });
</script>