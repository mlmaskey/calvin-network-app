<dom-module id="cwn-node-info">
    <style>
        #middleCol {
            transition: margin-top linear 200ms;
            -webkit-transition: margin-top linear 200ms;
            -moz-transition: margin-top linear 200ms;
            -ms-transition: margin-top linear 200ms;
        }
        .border {
          padding: 5px;
          display: inline-block;
          border-radius: 6px;
          border: 1px solid #eee;
          margin-top: 25px;
        }
        .description {
          font-size: 12px;
          color: #888;
        }
        :host {
            display: block;
        }
        [hidden] {
          display:none;
        }
    </style>

    <template>
        <div class="row" >

          <!-- Start Origins -->
          <div class="col-md-4 no-float">
            <h4 class="page-header" style="text-align:right">Origins</h4>
            <div>

              <div id="origin">
                <div style="text-align:right">
                  <div>
                    <cwn-info-link prmname$="{{feature.properties.origin}}"></cwn-info-link>
                  </div>
                  <div hidden$="{{!hasOriginDescription}}">
                    <div class="description">{{originDescription}}</div>
                  </div>
                </div>
              </div>


              <template is="dom-repeat" items="{{origins}}">
                <div style="text-align:right;margin-bottom:20px">
                  <div>
                    <cwn-info-link prmname$="{{item.name}}"></cwn-info-link>&nbsp;&nbsp;&nbsp;

                    <a href="{{item.link}}" hidden$="{{!item.hasLink}}">
                      <i class="fa fa-long-arrow-right" style="font-size:32px;display:inline-block;"></i>
                    </a>

                    <span hidden$="{{item.hasLink}}">
                        <i class="fa fa-long-arrow-right" style="color:#888;font-size:32px;display:inline-block;"></i>
                    </span>

                  </div>
                  <div class="description" hidden$="{{!item.description}}" style="margin-right: 55px">{{item.description}}</div>
                </div>
              </template>
            </div>
          </div>
          <!-- End Origins -->

          <!-- Start Feature -->
          <div class="col-md-4" style="text-align:center" id="middleCol">
              <div class="border">
                <table style="margin: 0 auto">
                  <tr>
                    <td>
                      <cwn-app-icon type$="{{type}}" width="72" height="72" fillFromType="true" style="margin:35px 15px 0 15px"></cwn-app-icon>
                    </td><td>
                      <h2>{{feature.properties.prmname}}</h2>
                      <div><b>{{feature.properties.type}}</b></div>

                    </td>
                  </tr>
                </table>
                <div style="padding: 10px 10px 0 10px; color: #888">{{feature.properties.description}}</div>
                <div hidden$="{{!showNavLinks}}">
                  <div><a class="btn btn-link" on-click="goToGraph"><i class="fa fa-code-fork"></i> View Network Graph</a></div>
                  <div><a class="btn btn-link" on-click="goTo"><i class="fa fa-map-marker"></i> Show on Map</a></div>
                </div>
                <div id="githubLink"></div>
                <!--
                <div hidden$="{{!islocal}}">
                    <div>
                      <a class="btn btn-link" href="{{editUrl}}">
                      <i class="fa fa-pencil"></i> Edit</a>
                    </div>
                </div>
              -->
              </div>
          </div>
          <!-- End Feature -->

          <!-- Start Terminals -->
          <div class="col-md-4">
            <h4 class="page-header">Terminals</h4>

            <div id="terminal">
              <div>
                <cwn-info-link prmname$="{{feature.properties.terminus}}"></cwn-info-link>
              </div>
              <div hidden$="{{!hasTerminalDescription}}">
                <div class="description">{{terminalDescription}}</div>
              </div>
            </div>

            <template is="dom-repeat" items="{{terminals}}">
              <div style="margin-bottom:20px">
                <div>

                  <a href="{{item.link}}" hidden$="{{!item.hasLink}}">
                    <i class="fa fa-long-arrow-right" style="font-size:32px;display:inline-block;"></i>
                  </a>

                  <span hidden$="{{item.hasLink}}">
                      <i class="fa fa-long-arrow-right" style="color:#888;font-size:32px;display:inline-block;"></i>
                  </span>

                  &nbsp;&nbsp;&nbsp;<cwn-info-link prmname$="{{item.name}}"></cwn-info-link>

                </div>
                <div hidden$="{{!item.description}}">
                  <div class="description" style="margin-left: 55px">{{item.description}}</div>
                </div>
              </div>
            </template>
          </div>
          <!-- End Terminals -->

        </div>
    </template>
</dom-module>

<script>
    Polymer({
        is : 'cwn-node-info',

        properties : {
            feature : {
              type : Object,
              observer : 'update'
            },
            ds : {
              type : Object,
              observer : 'update'
            },
            leaflet : {
              type : Object
            },
            islocal : {
              type : Boolean
            }
        },

        ready : function() {
          this.hasOriginDescription = false;
          this.originDescription = '';
          this.editUrl = '';
          this.originUrl = '';
          this.terminalUrl = '';
          this.showNavLinks = false;
          this.hasTerminalDescription = false;
          this.terminalDescription = '';
          this.type = '';
          this.origins = [];
          this.terminals = [];

          $(window).on('resize', this.updateSize.bind(this));
        },

        update : function() {
            if( !CWN.ds || !this.feature ) return;

            this.type = this.feature.properties.type;
            this.editUrl = '#edit/'+this.feature.properties.prmname;

            this.origins = [];
            this.terminals = [];

            var link, node, types = ['origins', 'terminals'];
            types.forEach(function(type){
              if( this.feature && this.feature.properties[type] ) {
                for( var i = 0; i < this.feature.properties[type].length; i++ ) {
                  link = CWN.ds.lookupMap[this.feature.properties[type][i].link_prmname];
                  node = CWN.ds.lookupMap[this.feature.properties[type][i].prmname];

                  if( link ) {
                    this[type].push({
                      name: node.properties.prmname,
                      link: '#info/'+link.properties.prmname,
                      hasLink : true,
                      description: node ? node.properties.description : ''
                    });
                  } else {
                    this.origins.push({
                        name: this.feature.properties.origins[i].prmname,
                        hasLink : false,
                        link: '',
                        description: ''
                    });
                  }
                }
              }
            }.bind(this));

            if( this.feature.properties.repo ) {
              this.$.githubLink.innerHTML = '<a class="btn btn-link" href="https://github.com/ucd-cws/calvin-network-data/tree/'+
                this.feature.properties.repo.branch+this.feature.properties.repo.dir+'" target="_blank">'+
                '<i class="fa fa-github"></i> Show on GitHub</a>';
            }

            // stupid polymer hack! when will this stop!!!!!!!!!!
            this.origins = $.extend(true, [], this.origins);
            this.terminals = $.extend(true, [], this.terminals);

            $(window).on('resize', this.updateSize.bind(this));

            this.onTypeUpdate();
            this.onOriginUpdate();
            this.onTerminalUpdate();
        },

        createRenderLinks : function(name) {
          var link, i, tmp = [];
          var links = this[name];
          if(!links) return;

          for( i = 0; i < links.length; i++ ) {
            link = links[i];

            tmp.push({
              name: link.properties.prmname,
              link: '#info/'+link.properties.prmname,
              hasLink : true,
              description: link.properties.description ? link.properties.description : ''
            });
          }

          // stupid polymer... when will this crap work right!?
          this[name] = tmp;
        },

        onOriginUpdate : function() {
            if( !CWN.ds ) return;

            if( !this.feature.properties.origin ) return this.$.origin.style.display = 'none';
            else this.$.origin.style.display = 'block';

            this.hasOriginDescription = false;
            this.originDescription = '';

            if( CWN.ds.lookupMap[this.feature.properties.origin] ) {
                this.hasOriginDescription = true;
                this.originDescription = CWN.ds.lookupMap[this.feature.properties.origin].properties.description
            }
        },

        onTerminalUpdate : function() {
            if( !CWN.ds ) return;

            if( !this.feature.properties.terminus ) return this.$.terminal.style.display = 'none';
            else this.$.terminal.style.display = 'block';

            this.hasTerminalDescription = false;
            this.terminalDescription = '';

            if( CWN.ds.lookupMap[this.feature.properties.terminus] ) {
                this.hasTerminalDescription = true;
                this.terminalDescription = CWN.ds.lookupMap[this.feature.properties.terminus].properties.description
            }
        },

        onTypeUpdate : function() {
            if( !CWN.ds ) return;

            this.showNavLinks = true;

            if( this.feature.properties.type == 'Diversion' || this.feature.properties.type == 'Return Flow' ) {
                this.showNavLinks = false;
            }
        },

        updateSize : function() {
          var w = $(window).width();

          if( w < 992 ) {
            this.$.middleCol.style.marginTop = '0px';
            return;
          }

          var ele = $(this.$.middleCol);

          var h = ele.next().height();
          if( h < ele.prev().height() ) h = ele.prev().height();
          if( h < ele.height() ) h = ele.height();


          this.$.middleCol.style.marginTop = Math.floor(((h-ele.height()) / 2)) + 'px';
        },

        goTo : function() {
          window.location.hash = 'map';
          this.async(function() {
            var pts = this.feature.geometry.coordinates;
            this.leaflet.setView([pts[1], pts[0]], 12);
          });
        },

        goToGraph : function() {
          window.location.hash = 'graph/'+this.feature.properties.prmname;
        }
    });
</script>
