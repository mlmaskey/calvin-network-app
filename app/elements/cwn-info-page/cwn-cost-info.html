<dom-module id="cwn-cost-info">
    <template>
        <h2 class="page-header">Costs</h2>

        <div class="alert alert-info" hidden$="{{feature.properties.hasCosts}}">
          This node has no cost data associated with it.
        </div>
        <div class="alert alert-error" hidden$="{{!costLoadError}}">
          Error loading cost data.
        </div>
        <div hidden$="{{!costLoading}}" style="color:#888">
          Loading cost data...
        </div>

        <div hidden$="{{!showCostData}}">
          <div hidden$="{{!showMonthlyVariableCost}}">

            <div class="btn-group">
              <template is="x-repeat" items="{{costsMonths}}">
                <a class="btn btn-xs btn-primary" 
                  index$="{{item.index}}" 
                  on-click="_setMonth">{{item.label}}</a>
              </template>
            </div>

            <cwn-linechart 
              id="lineChart"
              label="{{costChartLabel}}" 
              xlabel="Capacity (kAF)" 
              ylabel="Cost ($/kAF)" 
              animate>
            </cwn-linechart>
          </div>

          <div hidden$="{{showConstantCost}}">
            <h5>Constant: $<span>{{costs.cost}}</span></h5>
          </div>

        </div>

        <h4 hidden$="{{!showConstraints}}">Constraints</h4>

        <h5 hidden$="{{!showConstantConstraints}}">
          Constant: $<span>{{constraintChart.constant}}</span>
        </h5>


        <div id="constraintChartAnchor"></div>
        <template is="x-template" id="constraintChartTimeSeries">
          <cwn-date-linechart
            data="{{data}}"
            cols="{{cols}}"
            options="{{options}}"
            start="{{start}}" 
            stop="{{stop}}">
          </cwn-date-linechart>
        </template>

        <template is="x-template" id="constraintChart">
          <cwn-linechart
            cols="{{cols}}"
            options="{{options}}">
          </cwn-linechart>
        </template>
    </template>
</dom-module>

<script>
    Polymer({
        is : 'cwn-cost-info',

        published : {
            feature : {
                type : Object
            },
            hasTimeSeries : {
                type : Boolean,
                notify : true
            }
        },

        bind : {
            feature : 'update'
        },

        configure : function() {
            return {
                costsMonths : [],
                costs : {
                  label : '',
                  data : {},
                  cost : 0, // for constant costs
                  selected : 0
                },

                constraintChart : {
                    constant: -1,
                    label : '',
                    isTimeSeries : false,
                    cols : [
                        {id:'date', type:'string'},
                        {id:'upper_value', type:'number'},
                        {id:'upper_interval', type:'number', role:'interval'},
                        {id:'lower_interval', type:'number', role:'interval'},
                        {id: 'tooltip', type: 'string', role:'tooltip'}
                    ],
                    data : [],
                    options : {
                        series: [{'color': '#F1CA3A'}],
                        intervals: { 'style':'area' },
                        vAxis : {
                          viewWindow:{ min: 0 }
                        }
                    }
                },

                months : ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],

                showCostData : false,
                showMonthlyVariableCost : false,
                showConstantCost : false,
                costChartLabel : '',
                costChartData : [],
                showConstraints : false,
                showConstantConstraints : false,
                showTimeSeriesConstraints : false,
                showChartConstraints : false,
                hasTimeSeries : false,
                charts : {}
            }
        },

        update : function() {
            if( !this.feature ) return;

            this.costLoading = false;
            this.costLoadError = false;

            this.constraintChart.data = [];
            this.constraintChart.isTimeSeries = false;
            this.hasTimeSeries = false;
            this.constraintChart.constant = -1;
            this.constraintChart.label = '';

            this.loadCostData();
        },

        loadCostData : function() {
          this.showCostData = false;
          this.showMonthlyVariableCost = false;
          this.showConstantCost = false;
          this.showConstantConstraints = false;

          if( !this.feature.properties.hasCosts ) return;
          this.costLoading = true;
          this.costLoadError = false;

          var type;
          if( this.feature.properties.type == 'Diversion' || this.feature.properties.type == 'Return Flow' ) {
            type = 'link';
          } else {
            type = 'node';
          }

          var params = '?prmname='+ this.feature.properties.prmname +
            '&type=' + type + '&attribute=costs'

          $.ajax({
              url : '/rest/getAttribute'+params,
              success : function(resp) {
                this.costLoading = false;
                if( !resp.costs ) return this.costLoadError = true;

                this.showCostData = true;

                this.renderCostData(JSON.parse(resp.costs));
              }.bind(this),
              error : function(resp) {
                this.costLoadError = true;
              }.bind(this)
          });
        },

        renderCostData : function(d) {
          if( d.constraints ) this.renderConstraints(d.constraints);

          if( !d.costs ) return;

          this.costs.label = d.costs.type;
          this.costs.data = {};
          this.costsMonths = [];
          this.costs.selected = 0;

          this.costs.cost = d.costs.cost;

          if( !d.costs.costs ) return;
          if( d.costs.costs.length == 0 ) return;

          for( var i = 0; i < d.costs.costs.length; i++ ) {
            var m = d.costs.costs[i];

            var label = m.label;
            if( (!label || label == '') && i < 12 ) label = this.months[i];

            this.costs.data[label] = [];
            this.costsMonths.push({
              index : i,
              label : label
            });

            for( var j = 0; j < m.costs.length; j++ ) {
              this.costs.data[label].push([
                m.costs[j].capacity,
                m.costs[j].cost
              ]);
            }

            this.costs.data[label].sort(function(a, b){
              if( a[0] > b[0] ) return 1;
              if( a[0] < b[0] ) return -1;
              return 0;
            });
            this.costs.data[label].splice(0,0, ['Capacity','Cost']);
          };
          this._setMonth(0);

          if( this.costs.label == 'Monthly Variable' ) this.showMonthlyVariableCost = true;
          if( this.costs.label == 'Constant' ) this.showConstantCost = true;
        },

        renderConstraints : function(constraints) {
          this.showConstraints = false;
          this.showConstantConstraints = false;

          if( constraints.constraint_type == 'Bounded' ) {
            var length = this.getContraintsLength(constraints);
            if( length < 12 ) length = 12;

            for( var i = 0; i < length; i++ ) {
              this.constraintChart.data.push(this.getConstraintRow(constraints, i));
            }

          } else if( constraints.constraint_type == 'Constrained' ) {

            if( constraints.constraint.bound_type == 'Constant') {
              this.constraintChart.constant = constraints.constraint.bound;
            } else if( constraints.constraint.bound_type == 'Monthly') {
              for( var i = 0; i < 12; i++ ) {
                this.constraintChart.data.push([
                  this.months[i],
                  constraints.constraint.bound[i],
                  null,
                  null,
                  'Constrained: '+constraints.constraint.bound[i]
                ]);
              }
            } if( constraints.constraint.bound_type == 'TimeSeries') {

              this.constraintChart.isTimeSeries = true;
              this.hasTimeSeries = true;
              for( var i = 0; i < constraints.constraint.bound.length; i++ ) {
                this.constraintChart.data.push([
                  constraints.constraint.date[i],
                  constraints.constraint.bound[i],
                  null,
                  null,
                  'Constrained: '+constraints.constraint.bound[i]
                ]);
              }

            }

          } else {
            console.log('Unknown Constraint Type: '+constraints.constraint_type);
          }

          this.updateConstraintUi();
        },

        getConstraintRow : function(constraints, index) {
          var row = [];

          if( constraints.lower && constraints.lower.bound_type == 'TimeSeries' ) {
            row.push(constraints.lower.date[index]);
          } else if ( constraints.upper && constraints.upper.bound_type == 'TimeSeries' ) {
            row.push(constraints.upper.date[index]);
          } else {
            row.push(this.months[index]);
          }

          var tooltip = row[0]+'\n';

          if( constraints.upper ) {
            if( constraints.upper.bound_type == 'Constant' ) {
              row.push(constraints.upper.bound);
              row.push(constraints.upper.bound);
              tooltip += 'Upper: '+constraints.upper.bound;
            } else if ( constraints.upper.bound_type == 'TimeSeries' || constraints.upper.bound_type == 'Monthly') {
              var i = index;
              if( i > 11 && constraints.upper.bound_type == 'Monthly' ) {
                i = parseInt(row[0].split("-")[1])-1;
              }

              row.push(constraints.upper.bound[i]);
              row.push(constraints.upper.bound[i]);
              tooltip += 'Upper: '+constraints.upper.bound[i];
            } else if ( constraints.upper.bound_type == 'None' ) {
              tooltip += 'Upper: None';
            }
          }

          if( constraints.lower ) {

            if( constraints.lower.bound_type == 'Constant' ) {
              row.push(constraints.lower.bound);
              tooltip += ', Lower: '+constraints.lower.bound;
            } else if ( constraints.lower.bound_type == 'TimeSeries' || constraints.lower.bound_type == 'Monthly' ) {
              var i = index;
              if( i > 11 && constraints.upper.bound_type == 'Monthly' ) {
                i = parseInt(row[0].split("-")[1])-1;
              }

              row.push(constraints.lower.bound[i]);
              tooltip += ', Lower: '+constraints.lower.bound[i];
            } else if ( constraints.lower.bound_type == 'None' ) {
              row.push(0);
              tooltip += ', Lower: 0';
            } else {
               tooltip += ', Lower: Unknown';
            }

          } 

          while(row.length < 4) row.push(null);

          row.push(tooltip);

          return row;
        },

        getContraintsLength : function(constraints) {
          var l = 0;
          if( constraints.lower ) {
            if( constraints.lower.bound_type == 'Constant' ) {
              l = 1;
            } else if ( constraints.lower.bound_type == 'TimeSeries' ) {
              this.constraintChart.isTimeSeries = true;
              this.hasTimeSeries = true;

              l = constraints.lower.bound.length;
            } else if ( constraints.lower.bound_type == 'Monthly' ) {
              l = constraints.lower.bound.length;
            }
          }
          if (constraints.upper ) {
            if( constraints.upper.bound_type == 'Constant' && l == 0 ) {
              l = 1;
            } else if(constraints.upper.bound_type == 'TimeSeries' && l < constraints.upper.bound.length ) {
              this.constraintChart.isTimeSeries = true;
              this.hasTimeSeries = true;

              l = constraints.upper.bound.length;
            } else if ( constraints.upper.bound_type == 'Monthly' && l < constraints.upper.bound.length ) {
              l = constraints.upper.bound.length;
            }
          }
          return l;
        },

        _setMonth : function(index) {
          this.costs.selected = (typeof index == 'object') ? parseInt(index.currentTarget.getAttribute('index')) : index;

          this.costChartLabel = this.costs.label+' - '+this.costsMonths[this.costs.selected].label;
          this.costChartData = this.costs.data[this.costsMonths[this.costs.selected].label];

          this.$.lineChart.update(this.costChartData);
        },

        updateConstraintUi : function() {
            if( this.constraintChart.data.length != 0 && this.constraintChart.constant != -1 ) {
                this.showConstraints = true;
            }

            if( this.constraintChart.constant != -1 ) {
                this.showConstantConstraints = true;
            }
            
            this.$.constraintChartAnchor.innerHTML = '';
            this.charts.constraintChart = null;


            if( this.constraintChart.data.length != 0 ) {
                var isline = false;
                if( constraintChart.isTimeSeries ) {
                    this.charts.constraintChart = this.$.constraintChartTimeSeries.stamp(this.constraintChart);
                } else {
                    isline = true;
                    this.charts.constraintChart = this.$.constraintChart.stamp(this.constraintChart);
                }
                this.hasTimeSeries = true;

                this.$.constraintChartAnchor.appendChild(this.charts.constraintChart.root);

                if( isline ) {
                  this.$.constraintChartAnchor.querySelector('cwn-linechart').update(this.constraintChart.data);
                }
            }
        }


    })
</script>