<dom-module id="cwn-map-menu">
    <style>
        :host {
            position: absolute;
            height: 100%;
            width: 320px;
            background: rgba(0,0,0,.8);
            color: white;
            border: 1px solid black;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: auto;

            transition: all 250ms linear;
            -webkit-transition: all 250ms linear;
            -moz-transition: all 250ms linear;
            -ms-transition: all 250ms linear;
        }
        #content {
            padding: 5px 5px 5px 15px;
        }
        .menu-root {
          background-color: rgba(0,0,0,.1);
          padding-left: 10px;
          border-radius: 3px;
        }
        .menu-item {
          padding: 5px;
          font-size: 14px;
        }
        .menu-item:hover {
          color: red;
          cursor: pointer;
        }
        .menu-item.hovered {
          color: red;
          background-color: rgba(255,255,255,.2);
        }
        :host(.closed) {
          transform: translateX(290px);
          -webkit-transform: translateX(290px);
          -moz-transform: translateX(290px);
          -ms-transform: translateX(290px);
        }
    </style>
    <template>
        <div>
          <a class="btn btn-link" style="color:white" on-click="toggle"><i id="toggle" class="fa fa-arrow-left"></i></a>
        </div>
        <div id="content"></div>
    </template>
</dom-module>

<script>
    Polymer({
        is : 'cwn-map-menu',

        ready : function() {
          this.classList.add('closed');
        },

        init : function() {
            this.state = {
              enabled : [],
              disabled : []
            };
            this.render();

            if( $(window).width() > 700 ) this.toggle();
        },

        getEnabled : function() {
          this.state = {
            enabled : ['California'],
            disabled : []
          };
          this._getEnabled('California');
          return this.state;
        },

        _getEnabled : function(name) {
          var ele = $(this).find('input[name="'+name+'"]');

          if( ele.is(':checked') ) {
            if( name != 'California' ) this.state.enabled.push(name);
            var region = CWN.ds.regionLookupMap[name];

            if( !region.subregions ) return;

            for( var i = 0; i < region.subregions.length; i++ ) {
              this._getEnabled(region.subregions[i]);
            }
          } else {
            this.state.disabled.push(name);
          }
        },

        render : function() {
            this.$.content.innerHTML = '';
            this.renderRegion('California', this.$.content);
        },

        renderRegion : function(regionName, root) {
            var ref = this;
            var region = CWN.ds.regionLookupMap[regionName];

            var panel = $('<div class="menu-root cwn-map-menu"></div>');
            var input = $('<div class="menu-item cwn-map-menu" name="'+region.name+'">'+
                          '<input type="checkbox" name="'+region.name+'" ' +
                            ( region.name == 'California' ? 'checked' : '') +' /> '+region.name+'</div>');

            var children = $('<div style="display:'+( region.name == 'California' ? 'block' : 'none')+'"></div>');
            panel.append(input);
            panel.append(children);

            root.appendChild(panel[0]);


            input.find('input').on('click', function(e){
              e.stopPropagation();

              var ele = $(this);

              if( ele.is(':checked') ) {
                  children.show('fast');
              } else {
                  children.hide('fast');
              }

              ref.fire('select', ref.getEnabled());
            });

            input
              .on('click', function(){
                input.find('input').trigger("click");
              })
              .on('mouseover', function(){
                this.fire('hover', regionName);
              }.bind(this))
              .on('mouseout', function(){
                this.fire('nohover', regionName);
              }.bind(this));


            if( !region.subregions ) return;

            for( var i = 0; i < region.subregions.length; i++ ) {
                this.renderRegion(region.subregions[i], children[0]);
            }
        },

        setHovered : function(region) {
          if( !region ) {
            $(this).find('.menu-item').removeClass('hovered');
            this.mouseOverRegion = null;
            return;
          }

          if( this.mouseOverRegion && region.name == this.mouseOverRegion.name ) return;

          $(this).find('.menu-item').removeClass('hovered');
          this.mouseOverRegion = region;

          $(this).find('.menu-item[name="'+region.name+'"]').addClass('hovered');
        },

        toggle : function() {
          if( $(this).hasClass('closed') ) {
            $(this).removeClass('closed');
            this.$.toggle.className = "fa fa-arrow-right";
          } else {
            $(this).addClass('closed');
            this.$.toggle.className = "fa fa-arrow-left";
          }
        }
    })
</script>
