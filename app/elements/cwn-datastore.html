<polymer-element name="cwn-datastore">
    <template></template>
    <script>
        Polymer('cwn-datastore', {
            loading: true,
            data : [],
            dataMap : {},

            ready : function() {
                google.load("visualization", '1', {
                    packages:['corechart', 'table'],
                    callback : function() {
                        this.init();
                    }.bind(this)
                });
            },

            init : function() {
                $.ajax({
                    type : 'POST',
                    url : 'http://localhost:7474/db/data/cypher',
                    data : {
                        query : 'MATCH n RETURN n.geojson',
                        params : {}
                    },
                    success : function(resp) {
                        for( var i = 0; i < resp.data.length; i++ ) {
                            var d = JSON.parse(resp.data[i][0]);
                            this._markCalibrationNode(d);
                            this.dataMap[d.properties.prmname] = d;
                            this.data.push(d);
                        }

                        this.fire('loaded');
                        this.loading = false;
                    }.bind(this),
                    error : function(resp) {
                        this.loading = false;
                        alert('Error retrieving json');
                    }.bind(this)
                });
            },

             _markCalibrationNode : function(node) {
                if( !node.properties.prmname.match(/^CN.*/) ) return;

                var hasIn = false;
                var hasOut = false;

                if( node.properties.terminals ) {
                    for( var i = 0; i < node.properties.terminals.length; i++ ) {
                        if( node.properties.terminals[i] != null ) {
                            hasOut = true;
                            break;
                        }
                    }
                }
                if( node.properties.origins ) {
                    for( var i = 0; i < node.properties.origins.length; i++ ) {
                        if( node.properties.origins[i] != null ) {
                            hasIn = true;
                            break;
                        }
                    }
                } 
                
                if( !hasIn && !hasOut ) return;
                if( hasIn && hasOut ) node.properties.calibrationMode = 'both';
                else if ( hasIn ) node.properties.calibrationMode = 'in';
                else if ( hasOut ) node.properties.calibrationMode = 'out';
            },
        })
    </script>
</polymer-element>