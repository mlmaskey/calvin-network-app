<polymer-element name="cwn-datastore" attributes="settings">
    <template></template>
    <script>
        Polymer('cwn-datastore', {
            loading: true,
            data : [],
            dataMap : {},

            loadingCharts : true,
            chartLoadHandlers : [],

            ready : function() {
                // elements that need charts can push to this array callbacks for when charts are loaded
                window.chartLoadHandlers = this.chartLoadHandlers;

                google.load("visualization", '1', {
                    packages:['corechart', 'table'],
                    callback : function() {
                        this.loadingCharts = false;
                        for( var i = 0; i < this.chartLoadHandlers.length; i++ ) {
                            this.chartLoadHandlers[i]();
                        }
                    }.bind(this)
                });
            },

            reload : function(callback) {
                this.loading = true;
                this.dataMap = {};
                this.data = [];

                this.init(callback);
            },

            init : function(callback) {
                $.ajax({
                    type : 'POST',
                    url : this.settings.neo4jUrl+'/cypher',
                    data : {
                        query : 'MATCH n RETURN n.geojson',
                        params : {}
                    },
                    success : function(resp) {
                        var d;
                        for( var i = 0; i < resp.data.length; i++ ) {
                            
                            // crappy sanity checking
                            try {
                                d = JSON.parse(resp.data[i][0]);
                            } catch (e) {
                                continue;
                            }
                            if( !d ) continue;
                            if( !d.properties ) continue;
                            if( !d.properties.prmname ) continue;

                            this._markCalibrationNode(d);
                            this.dataMap[d.properties.prmname] = d;
                            this.data.push(d);
                        }

                        this.fire('loaded');
                        this.loading = false;

                        if( callback ) callback();
                    }.bind(this),
                    error : function(resp) {
                        this.loading = false;
                        if( callback ) callback(true);
                        alert('Error retrieving data from: '+this.settings.neo4jUrl+'/cypher');
                    }.bind(this)
                });
            },

             _markCalibrationNode : function(node) {
                if( !node.properties.prmname.match(/^CN.*/) ) return;

                var hasIn = false;
                var hasOut = false;

                if( node.properties.terminals ) {
                    for( var i = 0; i < node.properties.terminals.length; i++ ) {
                        if( node.properties.terminals[i] != null ) {
                            hasOut = true;
                            break;
                        }
                    }
                }
                if( node.properties.origins ) {
                    for( var i = 0; i < node.properties.origins.length; i++ ) {
                        if( node.properties.origins[i] != null ) {
                            hasIn = true;
                            break;
                        }
                    }
                } 
                
                if( !hasIn && !hasOut ) return;
                if( hasIn && hasOut ) node.properties.calibrationMode = 'both';
                else if ( hasIn ) node.properties.calibrationMode = 'in';
                else if ( hasOut ) node.properties.calibrationMode = 'out';
            },
        })
    </script>
</polymer-element>