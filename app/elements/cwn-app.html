<polymer-element name="cwn-app">
    <template>
        <style>
            leaflet-map, core-animated-pages {
                height: 100%
            }
            .splash-screen {
              position: fixed;
              top: 100px;
              width: 100%;
              text-align: center;
               z-index: 20000;
            }
            .splash-screen-text {
              display: inline-block;
              background-color: rgba(0,0,0,.7);
              border-radius: 6px;
              box-shadow: 0 0 5px black;
              padding: 25px;
              font-size: 50px;
              color: white;
            }
        </style>

        <div class="splash-screen" hidden?="{{!$.ds.loading}}">
          <div class="splash-screen-text">
            Loading Network...<br />
            <span style="font-size:14px">{{$.settings.settings.neo4jUrl}}</span>
          </div>
        </div>

        <cwn-datastore id="ds" loading="{{loading}}" settings="{{$.settings.settings}}" on-loaded="{{onDataLoad}}"></cwn-datastore>

        <cwn-app-layout loading="{{loading}}">
            <a right-nav on-tap="{{showSettings}}">
              <span class="hidden-xs"><cwn-icon icon="fa-cogs"></cwn-icon> Settings</span>
              <span class="visible-xs"><cwn-icon icon="fa-cogs"></cwn-icon></span>
            </a>
            <a right-nav on-tap="{{showFilters}}">
              <span class="hidden-xs"><cwn-icon icon="fa-filter"></cwn-icon> Filters</span>
              <span class="visible-xs"><cwn-icon icon="fa-filter"></cwn-icon></span>
            </a>

            <cwn-filters id="filters" content legend="{{legend}}"></cwn-filters>
            <cwn-settings id="settings" ds="{{$.ds}}" content></cwn-settings>

            <core-animated-pages id="pages" content transitions="slide-from-right">
              <cwn-map legend="{{legend}}" ds="{{$.ds}}" filters="{{$.filters.filters}}" on-selected="{{onFeatureSelected}}"></cwn-map>
              <cwn-info-page id="info" ds="{{$.ds}}" settings="{{$.settings.settings}}"></cwn-info-page>
        </cwn-app-layout>

        
    </template>
    <script>
        Polymer('cwn-app', {
            PAGES : {
              MAP : 0,
              INFO : 1
            },

            legend : {
              'Power Plant'         : {
                color : '#3366cc',
                google : 'small_red'
              },
              'Agricultural Demand' : {
                  color : '#ff9900',
                  google : 'small_yellow'
              },
              'Junction'            : {
                  color : '#109618',
                  google : 'small_green'
              },
              'Pump Plant'          : {
                  color : '#990099',
                  google : 'small_blue'
              },
              'Water Treatment'     : {
                  color : '#0099c6',
                  google : 'small_purple'
              },
              'Surface Storage'     : {
                  color : '#dd4477',
                  google : 'measle_brown',
              },
              'Urban Demand'        : {
                  color : '#66aa00',
                  google : 'measle_grey'
              },
              'Sink'                : {
                  color : '#b82e2e',
                  google : 'measle_white'
              },
              'Groundwater Storage' : {
                  color : '#316395',
                  google : 'measle_turquoise'
              },
              'Non-Standard Demand' : {
                  color : '#22aa99',
                  google : 'shaded_dot'
              }
            },

            dataLoaded : false,
            dataLoadHandlers : [],

            ready : function() {
              $(window).on('hashchange', function(){
                this.setLocation();
              }.bind(this));
              this.setLocation();
            },

            setLocation : function() {
              var loc = window.location.hash.replace('#','').replace(/\/.*/,'');
              if( loc == '') loc = 'map';

              if( loc == 'map' ) {
                this.$.pages.selected = this.PAGES.MAP;
                this.async(function(){
                  this.shadowRoot.querySelector('cwn-map').$.leaflet.map.invalidateSize();
                });
              } else if ( loc == 'info' ) {
                this.$.pages.selected = this.PAGES.INFO;
                if( this.dataLoaded ) {
                  this.setInfoFeature();
                } else {
                  this.dataLoadHandlers.push(this.setInfoFeature.bind(this));
                }
              }
            },

            setInfoFeature : function() {
              var name = window.location.hash.replace('#','').split('/')[1];
              name = decodeURIComponent(name);
              this.$.info.feature = this.$.ds.nodeMap[name];
            },
           
            onDataLoad : function() {
              this.dataLoaded = true;
              for( var i = 0; i < this.dataLoadHandlers.length; i++ ) {
                this.dataLoadHandlers[i]();
              }
            },

            showFilters : function() {
                this.$.settings.hide();
                this.$.filters.toggle();
            },

            showSettings : function() {
                this.$.filters.hide();
                this.$.settings.toggle();
            },

            onFeatureSelected : function(e) {
              this.$.pages.selected = this.PAGES.INFO;
              window.location.hash = 'info/'+e.detail.properties.prmname;
            }
        });
    </script>
</polymer-element>